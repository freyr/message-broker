framework:
    messenger:
        # Failure transport for handling failed messages
        failure_transport: failed

        # Middleware configuration
        # DeduplicationMiddleware runs AFTER doctrine_transaction (priority -10)
        # This ensures deduplication INSERT is within the transaction
        default_middleware:
            enabled: true
            allow_no_handlers: false

        buses:
            messenger.bus.default:
                middleware:
                    - doctrine_transaction  # Priority 0 (starts transaction)
                    # DeduplicationMiddleware (priority -10) registered via service tag
                    # Runs after transaction starts, before handlers

        transports:
            # Outbox transport - AUTO-MANAGED (auto_setup: true)
            # No custom serialiser needed — messages are native PHP objects
            # OutboxToAmqpBridge consumes from this transport
            outbox:
                dsn: 'doctrine://default?table_name=messenger_outbox&queue_name=outbox'
                options:
                    auto_setup: true
                retry_strategy:
                  max_retries: 3
                  delay: 1000
                  multiplier: 2

            # AMQP publish transport - MANUAL MANAGEMENT (auto_setup: false)
            # OutboxToAmqpBridge publishes here
            # Uses OutboxSerializer to translate FQN → semantic name in 'type' header
            amqp:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\OutboxSerializer'
                options:
                    auto_setup: false
                retry_strategy:
                  max_retries: 3
                  delay: 1000
                  multiplier: 2

            # AMQP consumption transport - MANUAL MANAGEMENT (auto_setup: false)
            # Uses InboxSerializer to translate semantic name → FQN
            # Duplicate and rename for each queue your application consumes from
            amqp_orders:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\InboxSerializer'
                options:
                    auto_setup: false
                    queue:
                        name: 'orders_queue'
                retry_strategy:
                  max_retries: 3
                  delay: 1000
                  multiplier: 2

            # Failed transport - AUTO-MANAGED (auto_setup: true)
            failed:
                dsn: 'doctrine://default?queue_name=failed'
                options:
                    auto_setup: true

        routing:
            # Outbox messages - route domain events to outbox transport
            # Example:
            # 'App\Domain\Event\OrderPlaced': outbox
            # 'App\Domain\Event\UserRegistered': outbox

            # Inbox messages (consumed from AMQP transports)
            # Messages are deserialised by InboxSerializer into typed objects
            # DeduplicationMiddleware automatically prevents duplicate processing
            # Handlers execute synchronously (no routing needed — AMQP transport handles delivery)
            # Example handlers:
            # #[AsMessageHandler]
            # class OrderPlacedHandler { public function __invoke(OrderPlaced $message) {} }
