services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Inbox Serializer (for AMQP consumption transports)
    # - decode(): Translates semantic name to FQN (e.g., 'order.placed' → 'App\Message\OrderPlaced')
    # - encode(): Preserves semantic name via MessageNameStamp (for retry/failed scenarios)
    # Used on AMQP consumption transports (e.g., amqp_orders)
    Freyr\MessageBroker\Serializer\InboxSerializer:
        arguments:
            $serializer: '@serializer'
            $messageTypes: '%message_broker.inbox.message_types%'

    # Wire Format Serializer (for AMQP publishing transports)
    # - encode(): Reads stamps, translates FQN → semantic name, adds X-Message-Id header
    # - decode(): Restores FQN from X-Message-Class header (for retry/failed scenarios)
    # Used on AMQP publishing transport (where AmqpOutboxPublisher publishes)
    Freyr\MessageBroker\Serializer\WireFormatSerializer:
        arguments:
            $serializer: '@serializer'

    # Deduplication Store (DBAL implementation)
    Freyr\MessageBroker\Inbox\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication_table_name%'
            $logger: '@logger'

    # Deduplication Middleware (inbox pattern)
    # Runs AFTER doctrine_transaction middleware (priority -10)
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        arguments:
            $store: '@Freyr\MessageBroker\Inbox\DeduplicationStore'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # MessageIdStamp Middleware
    # Stamps OutboxMessage envelopes with MessageIdStamp at dispatch time
    Freyr\MessageBroker\Outbox\MessageIdStampMiddleware:
        tags:
            - { name: 'messenger.middleware' }

    # MessageNameStamp Middleware
    # Stamps OutboxMessage envelopes with MessageNameStamp at dispatch time
    # Extracts semantic name from #[MessageName] attribute once (single reflection point)
    Freyr\MessageBroker\Outbox\MessageNameStampMiddleware:
        tags:
            - { name: 'messenger.middleware' }

    # Outbox Publishing Middleware (core — transport-agnostic)
    # Delegates to transport-specific publishers via a service locator.
    # Publisher locator is populated by OutboxPublisherPass compiler pass.
    Freyr\MessageBroker\Outbox\OutboxPublishingMiddleware:
        arguments:
            $logger: '@logger'
        tags:
            - { name: 'messenger.middleware' }

    # AMQP Routing Strategy (convention-based with YAML overrides)
    Freyr\MessageBroker\Amqp\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Amqp\Routing\DefaultAmqpRoutingStrategy
        arguments:
            $defaultSenderName: 'amqp'
            $routingOverrides: '%message_broker.amqp.routing_overrides%'

    # AMQP Outbox Publisher (publishes outbox events to RabbitMQ)
    # Tagged for auto-registration by OutboxPublisherPass compiler pass.
    Freyr\MessageBroker\Amqp\AmqpOutboxPublisher:
        arguments:
            $senderLocator: !service_locator
                amqp: '@messenger.transport.amqp'
            $routingStrategy: '@Freyr\MessageBroker\Amqp\Routing\AmqpRoutingStrategyInterface'
            $logger: '@logger'
        tags:
            - { name: 'message_broker.outbox_publisher', transport: 'outbox' }

    # AMQP Topology Manager
    # Declares exchanges, queues, and bindings against RabbitMQ
    Freyr\MessageBroker\Amqp\TopologyManager:
        arguments:
            $topology: '%message_broker.amqp.topology%'
            $logger: '@logger'

    # AMQP Definitions Formatter
    # Generates RabbitMQ-compatible definitions JSON
    Freyr\MessageBroker\Amqp\DefinitionsFormatter:
        arguments:
            $topology: '%message_broker.amqp.topology%'

    # AMQP Connection Factory
    # Creates ext-amqp connections from DSN strings
    Freyr\MessageBroker\Amqp\AmqpConnectionFactory: ~

    # AMQP Topology Setup Command
    # Declares AMQP topology from configuration
    Freyr\MessageBroker\Amqp\Command\SetupAmqpTopologyCommand:
        arguments:
            $topologyManager: '@Freyr\MessageBroker\Amqp\TopologyManager'
            $definitionsFormatter: '@Freyr\MessageBroker\Amqp\DefinitionsFormatter'
            $connectionFactory: '@Freyr\MessageBroker\Amqp\AmqpConnectionFactory'
            $defaultDsn: '%env(default::MESSENGER_AMQP_DSN)%'
        tags: ['console.command']

    # Deduplication Store Cleanup Command
    # Removes old deduplication records
    Freyr\MessageBroker\Command\DeduplicationStoreCleanup:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication_table_name%'
        tags: ['console.command']
