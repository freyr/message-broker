services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Inbox Transport Factory (registers inbox:// DSN)
    Freyr\MessageBroker\Inbox\Transport\DoctrineInboxTransportFactory:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['messenger.transport_factory']

    # Outbox Transport Factory (registers outbox:// DSN)
    Freyr\MessageBroker\Outbox\Transport\DoctrineOutboxTransportFactory:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['messenger.transport_factory']

    # Auto-register all Normalizers using Symfony's native tag
    # These will be automatically added to the @serializer service
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Inbox Serializer (requires user configuration for message type mappings)
    # Users must configure this in their own services.yaml with message_types parameter
    Freyr\MessageBroker\Inbox\Serializer\InboxSerializer:
        arguments:
            $messageTypes: '%message_broker.inbox.message_types%'
            $serializer: '@serializer'

    # Inbox Commands
    Freyr\MessageBroker\Inbox\Command\AmqpInboxIngestCommand:
        arguments:
            $messageBus: '@messenger.default_bus'
        tags: ['console.command']

    Freyr\MessageBroker\Inbox\Command\AmqpSetupCommand:
        tags: ['console.command']

    # Outbox Serializer
    Freyr\MessageBroker\Outbox\Serializer\OutboxSerializer:
        arguments:
            $serializer: '@serializer'

    # AMQP Routing Strategy (default convention-based routing)
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # Outbox Bridge (publishes outbox events to AMQP)
    # Note: Handler is auto-configured via #[AsMessageHandler(fromTransport: 'outbox')] attribute
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        arguments:
            $eventBus: '@messenger.default_bus'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $serializer: '@Freyr\MessageBroker\Outbox\Serializer\OutboxSerializer'
            $logger: '@logger'

    # Outbox Cleanup Command (optional maintenance)
    Freyr\MessageBroker\Outbox\Command\CleanupOutboxCommand:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.outbox.table_name%'
            $queueName: 'outbox'
        tags: ['console.command']
