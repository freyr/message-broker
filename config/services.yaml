services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Custom ObjectNormalizer with property promotion support
    # This overrides Symfony's default ObjectNormalizer with propertyTypeExtractor
    # Lower priority (-1000) ensures it runs as fallback after specialized normalizers
    Freyr\MessageBroker\Serializer\Normalizer\PropertyPromotionObjectNormalizer:
        autowire: true
        class: Symfony\Component\Serializer\Normalizer\ObjectNormalizer
        arguments:
            $propertyTypeExtractor: '@property_info'
        tags:
            - { name: 'serializer.normalizer', priority: -1000 }

    # Inbox Serializer (for AMQP consumption transports)
    # - decode(): Translates semantic name to FQN (e.g., 'order.placed' → 'App\Message\OrderPlaced')
    # - encode(): Preserves semantic name via MessageNameStamp (for retry/failed scenarios)
    # Used on AMQP consumption transports (e.g., amqp_orders)
    Freyr\MessageBroker\Serializer\InboxSerializer:
        arguments:
            $serializer: '@serializer'
            $messageTypes: '%message_broker.inbox.message_types%'

    # Outbox Serializer (for AMQP publishing transports)
    # - encode(): Extracts semantic name from #[MessageName] attribute (e.g., 'App\Event\OrderPlaced' → 'order.placed')
    # - decode(): Restores FQN from X-Message-Class header (for retry/failed scenarios)
    # Used on AMQP publishing transport (where OutboxToAmqpBridge publishes)
    Freyr\MessageBroker\Serializer\OutboxSerializer:
        arguments:
            $serializer: '@serializer'

    # Deduplication Store (DBAL implementation)
    Freyr\MessageBroker\Inbox\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $logger: '@logger'

    # Deduplication Middleware (inbox pattern)
    # Runs AFTER doctrine_transaction middleware (priority -10)
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        arguments:
            $store: '@Freyr\MessageBroker\Inbox\DeduplicationStore'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # AMQP Routing Strategy (default convention-based routing)
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # Outbox Bridge (publishes outbox events to AMQP)
    # Note: Handler is auto-configured via #[AsMessageHandler(fromTransport: 'outbox')] attribute
    # Adds MessageIdStamp to envelope - stamps automatically serialized to X-Message-Stamp-* headers
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        autoconfigure: true
        arguments:
            $eventBus: '@messenger.default_bus'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $logger: '@logger'

    # Deduplication Store Cleanup Command
    # Removes old deduplication records
    Freyr\MessageBroker\Command\DeduplicationStoreCleanup:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['console.command']
