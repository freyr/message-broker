services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Inbox Transport Factory (registers inbox:// DSN)
    Freyr\MessageBroker\Inbox\Transport\DoctrineInboxTransportFactory:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['messenger.transport_factory']

    # Outbox Transport Factory (registers outbox:// DSN)
    Freyr\MessageBroker\Outbox\Transport\DoctrineOutboxTransportFactory:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['messenger.transport_factory']

    # Inbox Serializer (requires user configuration for message type mappings)
    # Users must configure this in their own services.yaml with message_types parameter
    Freyr\MessageBroker\Inbox\Serializer\TypedInboxSerializer:
        arguments:
            $messageTypes: '%message_broker.inbox.message_types%'

    # Inbox Commands
    Freyr\MessageBroker\Inbox\Command\AmqpInboxIngestCommand:
        arguments:
            $messageBus: '@messenger.default_bus'
        tags: ['console.command']

    Freyr\MessageBroker\Inbox\Command\AmqpSetupCommand:
        tags: ['console.command']

    # Outbox Serializer
    Freyr\MessageBroker\Outbox\Serializer\OutboxEventSerializer:

    # AMQP Routing Strategy (default convention-based routing)
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # Publishing Strategy Registry
    Freyr\MessageBroker\Outbox\Publishing\PublishingStrategyRegistry:
        arguments:
            $strategies: !tagged_iterator 'message_broker.outbox.publishing_strategy'

    # AMQP Publishing Strategy
    Freyr\MessageBroker\Outbox\Publishing\AmqpPublishingStrategy:
        arguments:
            $eventBus: '@messenger.default_bus'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $serializer: '@Freyr\MessageBroker\Outbox\Serializer\OutboxEventSerializer'
            $logger: '@logger'
        tags: ['message_broker.outbox.publishing_strategy']

    # Outbox Bridge (generic handler for all outbox events)
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        autoconfigure: false
        arguments:
            $strategyRegistry: '@Freyr\MessageBroker\Outbox\Publishing\PublishingStrategyRegistry'
            $eventBus: '@messenger.default_bus'
            $logger: '@logger'
            $dlqTransportName: '%message_broker.outbox.dlq_transport%'
        tags:
            - { name: 'messenger.message_handler', from_transport: 'outbox', handles: '*' }

    # Outbox Cleanup Command (optional maintenance)
    Freyr\MessageBroker\Outbox\Command\CleanupOutboxCommand:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.outbox.table_name%'
            $queueName: 'outbox'
        tags: ['console.command']
