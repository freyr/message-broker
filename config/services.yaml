services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers using Symfony's native tag
    # These will be automatically added to the @serializer service
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Message Name Serializer (unified for inbox & outbox)
    # - encode(): Sets semantic name in 'type' header (outbox)
    # - decode(): Translates semantic name to FQN (inbox)
    Freyr\MessageBroker\Serializer\MessageNameSerializer:
        arguments:
            $messageTypes: '%message_broker.inbox.message_types%'

    # Deduplication Middleware (inbox pattern)
    Freyr\MessageBroker\DeduplicationMiddleware:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $logger: '@logger'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # AMQP Routing Strategy (default convention-based routing)
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # Outbox Bridge (publishes outbox events to AMQP)
    # Note: Handler is auto-configured via #[AsMessageHandler(fromTransport: 'outbox')] attribute
    # Adds MessageIdStamp to envelope - stamps automatically serialized to X-Message-Stamp-* headers
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        arguments:
            $eventBus: '@messenger.default_bus'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $logger: '@logger'

    # Outbox Cleanup Command (optional maintenance)
    # Uses default table name 'messenger_outbox' and queue name 'outbox'
    # Customize in your services.yaml if you use different names
    Freyr\MessageBroker\Outbox\Command\CleanupOutboxCommand:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
        tags: ['console.command']
