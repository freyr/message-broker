services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Inbox Serializer (for AMQP consumption transports)
    # - decode(): Translates semantic name to FQN (e.g., 'order.placed' → 'App\Message\OrderPlaced')
    # - encode(): Preserves semantic name via MessageNameStamp (for retry/failed scenarios)
    # Used on AMQP consumption transports (e.g., amqp_orders)
    Freyr\MessageBroker\Serializer\InboxSerializer:
        arguments:
            $serializer: '@serializer'
            $messageTypes: '%message_broker.inbox.message_types%'

    # Wire Format Serializer (for AMQP publishing transports)
    # - encode(): Reads stamps, translates FQN → semantic name, adds X-Message-Id header
    # - decode(): Restores FQN from X-Message-Class header (for retry/failed scenarios)
    # Used on AMQP publishing transport (where AmqpOutboxPublisher publishes)
    Freyr\MessageBroker\Serializer\WireFormatSerializer:
        arguments:
            $serializer: '@serializer'

    # Deduplication Store (DBAL implementation)
    Freyr\MessageBroker\Contracts\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication.table_name%'
            $logger: '@logger'

    # Deduplication Middleware (inbox pattern)
    # Runs AFTER doctrine_transaction middleware (priority -10)
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        arguments:
            $store: '@Freyr\MessageBroker\Contracts\DeduplicationStore'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # MessageIdStamp Middleware
    # Stamps OutboxMessage envelopes with MessageIdStamp at dispatch time
    Freyr\MessageBroker\Outbox\MessageIdStampMiddleware:
        tags:
            - { name: 'messenger.middleware' }

    # MessageNameStamp Middleware
    # Stamps OutboxMessage envelopes with MessageNameStamp at dispatch time
    # Extracts semantic name from #[MessageName] attribute once (single reflection point)
    Freyr\MessageBroker\Outbox\MessageNameStampMiddleware:
        tags:
            - { name: 'messenger.middleware' }

    # Outbox Publishing Middleware (core — transport-agnostic)
    # Delegates to transport-specific publishers via a service locator.
    # Publisher locator is populated by OutboxPublisherPass compiler pass.
    Freyr\MessageBroker\Outbox\OutboxPublishingMiddleware:
        arguments:
            $logger: '@logger'
        tags:
            - { name: 'messenger.middleware' }

    # Ordered Outbox Transport Factory
    # Creates OrderedOutboxTransport from ordered-doctrine:// DSN.
    # Always registered — inert unless the DSN matches.
    Freyr\MessageBroker\Outbox\Transport\OrderedOutboxTransportFactory:
        arguments:
            $registry: '@doctrine'
        tags:
            - { name: 'messenger.transport_factory' }

    # PartitionKeyStamp Middleware
    # Validates that OutboxMessage envelopes carry a PartitionKeyStamp at dispatch time.
    # Required when using ordered-doctrine:// transport for per-partition FIFO ordering.
    Freyr\MessageBroker\Outbox\PartitionKeyStampMiddleware:
        tags:
            - { name: 'messenger.middleware' }

    # Deduplication Store Cleanup Command
    # Removes old deduplication records
    Freyr\MessageBroker\Command\DeduplicationStoreCleanup:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication.table_name%'
        tags: ['console.command']

    # Deduplication Setup Command
    # Creates the deduplication table from configuration
    Freyr\MessageBroker\Command\SetupDeduplicationCommand:
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication.table_name%'
            $migrationsConfiguration: '@?doctrine.migrations.configuration'
        tags: ['console.command']
