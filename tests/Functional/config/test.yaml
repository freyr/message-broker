framework:
    secret: 'test-secret'
    test: true
    messenger:
        failure_transport: failed

        buses:
            messenger.bus.default:
                # Note: DeduplicationMiddleware is listed explicitly here because
                # the test kernel's service definitions duplicate bundle config.
                # In production, the bundle's services.yaml registers it via
                # messenger.middleware tag (priority -10). Both approaches produce
                # the same middleware ordering.
                default_middleware:
                    enabled: true
                    allow_no_handlers: false
                middleware:
                    - doctrine_transaction
                    - 'Freyr\MessageBroker\Inbox\DeduplicationMiddleware'

        transports:
            # Outbox transport - AUTO-MANAGED (auto_setup: true)
            outbox:
                dsn: 'doctrine://default?table_name=messenger_outbox&queue_name=outbox'
                serializer: 'Freyr\MessageBroker\Serializer\OutboxSerializer'
                options:
                    auto_setup: true
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP publish transport - MANUAL MANAGEMENT (auto_setup: false)
            amqp:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\OutboxSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                        type: 'topic'
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP consumption transport - MANUAL MANAGEMENT (auto_setup: false)
            amqp_test:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\InboxSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                    queues:
                        test_inbox: ~
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # Failed transport - AUTO-MANAGED (auto_setup: true)
            failed:
                dsn: 'doctrine://default?queue_name=failed'
                options:
                    auto_setup: true

        routing:
            # Route outbox messages to outbox transport
            'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent': outbox
            'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced': outbox

doctrine:
    dbal:
        url: '%env(DATABASE_URL)%'
        driver: 'pdo_mysql'
        charset: utf8mb4
        default_table_options:
            charset: utf8mb4
            collate: utf8mb4_unicode_ci
        types:
            id_binary: Freyr\MessageBroker\Doctrine\Type\IdType
        mapping_types:
            binary: id_binary

    # Standard ORM configuration (required by doctrine_transaction middleware)
    # Even though we don't use entities, ORM must be properly configured for the middleware
    orm:
        # Use PHP 8.4 native lazy objects (symfony/var-exporter 8.0 removed LazyGhost support)
        enable_native_lazy_objects: true   # PHP 8.4+ native lazy objects
        report_fields_where_declared: true # Standard Symfony setting
        naming_strategy: doctrine.orm.naming_strategy.underscore_number_aware
        auto_mapping: true
        mappings:
            # Empty mappings - we use DBAL only, but ORM config must be complete
            FreyrMessageBroker:
                is_bundle: false
                type: attribute
                dir: '%kernel.project_dir%/src/Entity'
                prefix: 'Freyr\MessageBroker\Entity'
                alias: FreyrMessageBroker

message_broker:
    inbox:
        message_types:
            'test.event.sent': 'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent'
            'test.order.placed': 'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced'

services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Use NullLogger to suppress logging output during tests
    logger:
        class: Psr\Log\NullLogger
        public: true

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../../../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Custom ObjectNormalizer with property promotion support
    Freyr\MessageBroker\Serializer\Normalizer\PropertyPromotionObjectNormalizer:
        autowire: true
        class: Symfony\Component\Serializer\Normalizer\ObjectNormalizer
        arguments:
            $propertyTypeExtractor: '@property_info'
        tags:
            - { name: 'serializer.normalizer', priority: -1000 }

    # Inbox Serializer
    Freyr\MessageBroker\Serializer\InboxSerializer:
        arguments:
            $serializer: '@serializer'
            $messageTypes: '%message_broker.inbox.message_types%'

    # Outbox Serializer
    Freyr\MessageBroker\Serializer\OutboxSerializer:
        arguments:
            $serializer: '@serializer'

    # Deduplication Store
    Freyr\MessageBroker\Inbox\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        public: true
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication_table_name%'
            $logger: '@logger'

    # Deduplication Middleware
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        arguments:
            $store: '@Freyr\MessageBroker\Inbox\DeduplicationStore'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # AMQP Routing Strategy
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # Outbox Bridge
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        autoconfigure: true
        arguments:
            $eventBus: '@messenger.default_bus'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $logger: '@logger'

    # Test Handlers (for inbox flow tests)
    Freyr\MessageBroker\Tests\Functional\Fixtures\TestEventHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlacedHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\ThrowingTestEventHandler:
        autoconfigure: true
