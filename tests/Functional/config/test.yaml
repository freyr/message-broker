framework:
    secret: 'test-secret'
    test: true
    http_method_override: false
    handle_all_throwables: true
    php_errors:
        log: true
    messenger:
        failure_transport: failed

        buses:
            messenger.bus.default:
                default_middleware:
                    enabled: true
                    allow_no_handlers: false
                middleware:
                    - 'Freyr\MessageBroker\Outbox\MessageIdStampMiddleware'
                    - 'Freyr\MessageBroker\Outbox\MessageNameStampMiddleware'
                    - doctrine_transaction
                    - 'Freyr\MessageBroker\Outbox\OutboxPublishingMiddleware'
                    - 'Freyr\MessageBroker\Inbox\DeduplicationMiddleware'

        transports:
            # Outbox transport - AUTO-MANAGED (auto_setup: true)
            # Uses Symfony's JSON serialiser (FQN in type header â€” internal storage)
            outbox:
                dsn: 'doctrine://default?table_name=messenger_outbox&queue_name=outbox'
                serializer: messenger.transport.symfony_serializer
                options:
                    auto_setup: true
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP publish transport (for functional outbox flow tests)
            amqp:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\WireFormatSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                        type: 'topic'
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP consumption transport (for functional inbox tests)
            amqp_test:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\InboxSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                    queues:
                        test_inbox: ~
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # Failed transport - AUTO-MANAGED (auto_setup: true)
            failed:
                dsn: 'doctrine://default?queue_name=failed'
                options:
                    auto_setup: true

        routing:
            # Route outbox messages to outbox transport
            'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent': outbox
            'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced': outbox

doctrine:
    dbal:
        url: '%env(DATABASE_URL)%'
        driver: 'pdo_mysql'
        charset: utf8mb4
        default_table_options:
            charset: utf8mb4
            collate: utf8mb4_unicode_ci
        types:
            id_binary: Freyr\MessageBroker\Doctrine\Type\IdType
        mapping_types:
            binary: id_binary

    # Standard ORM configuration (required by doctrine_transaction middleware)
    # Even though we don't use entities, ORM must be properly configured for the middleware
    # Note: lazy object strategy is set in TestKernel::configureContainer() based on PHP version
    orm:
        report_fields_where_declared: true # Standard Symfony setting
        naming_strategy: doctrine.orm.naming_strategy.underscore_number_aware
        auto_mapping: true
        mappings:
            # Empty mappings - we use DBAL only, but ORM config must be complete
            FreyrMessageBroker:
                is_bundle: false
                type: attribute
                dir: '%kernel.project_dir%/tests/Functional/Entity'
                prefix: 'Freyr\MessageBroker\Tests\Functional\Entity'
                alias: FreyrMessageBroker

message_broker:
    inbox:
        message_types:
            'test.event.sent': 'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent'
            'test.order.placed': 'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced'

services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Test-specific overrides (bundle services loaded via FreyrMessageBrokerExtension)

    # Suppress logging output during tests
    logger:
        class: Psr\Log\NullLogger
        public: true

    # Make DeduplicationStore public for direct access in tests
    Freyr\MessageBroker\Contracts\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        public: true
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication.table_name%'
            $logger: '@logger'

    # Test Outbox Publisher (publishes to AMQP for functional tests)
    Freyr\MessageBroker\Tests\Functional\Fixtures\TestOutboxPublisher:
        arguments:
            $senderLocator: !service_locator
                amqp: '@messenger.transport.amqp'
        tags:
            - { name: 'message_broker.outbox_publisher', transport: 'outbox' }

    # Test Handlers (for inbox flow tests)
    Freyr\MessageBroker\Tests\Functional\Fixtures\TestEventHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlacedHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\ThrowingTestEventHandler:
        autoconfigure: true
