framework:
    secret: 'test-secret'
    test: true
    http_method_override: false
    handle_all_throwables: true
    php_errors:
        log: true
    messenger:
        failure_transport: failed

        buses:
            messenger.bus.default:
                default_middleware:
                    enabled: true
                    allow_no_handlers: false
                middleware:
                    - 'Freyr\MessageBroker\Outbox\MessageIdStampMiddleware'
                    - doctrine_transaction
                    - 'Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge'
                    - 'Freyr\MessageBroker\Inbox\DeduplicationMiddleware'

        transports:
            # Outbox transport - AUTO-MANAGED (auto_setup: true)
            outbox:
                dsn: 'doctrine://default?table_name=messenger_outbox&queue_name=outbox'
                serializer: 'Freyr\MessageBroker\Serializer\OutboxSerializer'
                options:
                    auto_setup: true
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP publish transport - MANUAL MANAGEMENT (auto_setup: false)
            amqp:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\OutboxSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                        type: 'topic'
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # AMQP consumption transport - MANUAL MANAGEMENT (auto_setup: false)
            amqp_test:
                dsn: '%env(MESSENGER_AMQP_DSN)%'
                serializer: 'Freyr\MessageBroker\Serializer\InboxSerializer'
                options:
                    auto_setup: false
                    exchange:
                        name: 'test_events'
                    queues:
                        test_inbox: ~
                retry_strategy:
                    max_retries: 3
                    delay: 1000
                    multiplier: 2

            # Failed transport - AUTO-MANAGED (auto_setup: true)
            failed:
                dsn: 'doctrine://default?queue_name=failed'
                options:
                    auto_setup: true

        routing:
            # Route outbox messages to outbox transport
            'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent': outbox
            'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced': outbox

doctrine:
    dbal:
        url: '%env(DATABASE_URL)%'
        driver: 'pdo_mysql'
        charset: utf8mb4
        default_table_options:
            charset: utf8mb4
            collate: utf8mb4_unicode_ci
        types:
            id_binary: Freyr\MessageBroker\Doctrine\Type\IdType
        mapping_types:
            binary: id_binary

    # Standard ORM configuration (required by doctrine_transaction middleware)
    # Even though we don't use entities, ORM must be properly configured for the middleware
    # Note: lazy object strategy is set in TestKernel::configureContainer() based on PHP version
    orm:
        report_fields_where_declared: true # Standard Symfony setting
        naming_strategy: doctrine.orm.naming_strategy.underscore_number_aware
        auto_mapping: true
        mappings:
            # Empty mappings - we use DBAL only, but ORM config must be complete
            FreyrMessageBroker:
                is_bundle: false
                type: attribute
                dir: '%kernel.project_dir%/tests/Functional/Entity'
                prefix: 'Freyr\MessageBroker\Tests\Functional\Entity'
                alias: FreyrMessageBroker

message_broker:
    inbox:
        message_types:
            'test.event.sent': 'Freyr\MessageBroker\Tests\Functional\Fixtures\TestEvent'
            'test.order.placed': 'Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlaced'
    amqp:
        topology:
            exchanges:
                topology_test_exchange:
                    type: topic
                    durable: true
            queues:
                topology_test_queue:
                    durable: true
            bindings:
                - exchange: topology_test_exchange
                  queue: topology_test_queue
                  binding_key: 'test.#'

services:
    _defaults:
        autowire: false
        autoconfigure: false
        public: false

    # Use NullLogger to suppress logging output during tests
    logger:
        class: Psr\Log\NullLogger
        public: true

    # Doctrine Integration
    Freyr\MessageBroker\Doctrine\Type\IdType:
        tags:
            - { name: 'doctrine.dbal.types', type: 'id_binary' }

    # Auto-register all Normalizers
    Freyr\MessageBroker\Serializer\Normalizer\:
        resource: '../../../src/Serializer/Normalizer/'
        tags: ['serializer.normalizer']

    # Inbox Serializer
    Freyr\MessageBroker\Serializer\InboxSerializer:
        arguments:
            $serializer: '@serializer'
            $messageTypes: '%message_broker.inbox.message_types%'

    # Outbox Serializer
    Freyr\MessageBroker\Serializer\OutboxSerializer:
        arguments:
            $serializer: '@serializer'

    # Deduplication Store
    Freyr\MessageBroker\Inbox\DeduplicationStore:
        class: Freyr\MessageBroker\Inbox\DeduplicationDbalStore
        public: true
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $tableName: '%message_broker.inbox.deduplication_table_name%'
            $logger: '@logger'

    # Deduplication Middleware
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        arguments:
            $store: '@Freyr\MessageBroker\Inbox\DeduplicationStore'
        tags:
            - { name: 'messenger.middleware', priority: -10 }

    # AMQP Routing Strategy
    Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface:
        class: Freyr\MessageBroker\Outbox\Routing\DefaultAmqpRoutingStrategy

    # MessageIdStamp Middleware
    Freyr\MessageBroker\Outbox\MessageIdStampMiddleware: ~

    # Outbox Bridge (middleware)
    Freyr\MessageBroker\Outbox\EventBridge\OutboxToAmqpBridge:
        arguments:
            $senderLocator: !service_locator
                amqp: '@messenger.transport.amqp'
            $routingStrategy: '@Freyr\MessageBroker\Outbox\Routing\AmqpRoutingStrategyInterface'
            $logger: '@logger'

    # AMQP Topology Manager
    Freyr\MessageBroker\Amqp\TopologyManager:
        arguments:
            $topology: '%message_broker.amqp.topology%'
            $logger: '@logger'

    # AMQP Definitions Formatter
    Freyr\MessageBroker\Amqp\DefinitionsFormatter:
        arguments:
            $topology: '%message_broker.amqp.topology%'

    # AMQP Connection Factory
    Freyr\MessageBroker\Amqp\AmqpConnectionFactory: ~

    # AMQP Topology Setup Command (public for functional tests)
    Freyr\MessageBroker\Command\SetupAmqpTopologyCommand:
        public: true
        arguments:
            $topologyManager: '@Freyr\MessageBroker\Amqp\TopologyManager'
            $definitionsFormatter: '@Freyr\MessageBroker\Amqp\DefinitionsFormatter'
            $connectionFactory: '@Freyr\MessageBroker\Amqp\AmqpConnectionFactory'
            $defaultDsn: '%env(MESSENGER_AMQP_DSN)%'
        tags: ['console.command']

    # Test Handlers (for inbox flow tests)
    Freyr\MessageBroker\Tests\Functional\Fixtures\TestEventHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\OrderPlacedHandler:
        autoconfigure: true

    Freyr\MessageBroker\Tests\Functional\Fixtures\ThrowingTestEventHandler:
        autoconfigure: true
