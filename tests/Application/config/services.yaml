services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Disable messenger logging in tests
    logger:
        class: Psr\Log\NullLogger

    # Test fixtures
    Freyr\MessageBroker\Tests\Fixtures\:
        resource: '../../Fixtures/'

    # Test message collector (not auto-configured as handler)
    Freyr\MessageBroker\Tests\Functional\Handler\TestMessageCollector:
        public: true
        autoconfigure: true

    # Explicitly register DeduplicationMiddleware for tests
    Freyr\MessageBroker\Inbox\DeduplicationMiddleware:
        public: true
        arguments:
            $connection: '@doctrine.dbal.default_connection'
            $logger: '@logger'
        tags:
            - { name: 'messenger.middleware', priority: -10, bus: 'messenger.bus.default' }

    # Register normalizers for serialization
    Freyr\MessageBroker\Serializer\Normalizer\IdNormalizer:
        tags: ['serializer.normalizer']

    Freyr\MessageBroker\Serializer\Normalizer\CarbonImmutableNormalizer:
        tags: ['serializer.normalizer']
